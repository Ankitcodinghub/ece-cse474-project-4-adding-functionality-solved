# ece-cse474-project-4-adding-functionality-solved
**TO GET THIS SOLUTION VISIT:** [ECE-CSE474 Project 4-ADDING FUNCTIONALITY‚Äù Solved](https://www.ankitcodinghub.com/product/ece-cse474-project-4-adding-functionality-solved/)


---

üì© **If you need this solution or have special requests:** **Email:** ankitcoding@gmail.com  
üì± **WhatsApp:** +1 419 877 7882  
üìÑ **Get a quote instantly using this form:** [Ask Homework Questions](https://www.ankitcodinghub.com/services/ask-homework-questions/)

*We deliver fast, professional, and affordable academic help.*

---

<h2>Description</h2>



<div class="kk-star-ratings kksr-auto kksr-align-center kksr-valign-top" data-payload="{&quot;align&quot;:&quot;center&quot;,&quot;id&quot;:&quot;97555&quot;,&quot;slug&quot;:&quot;default&quot;,&quot;valign&quot;:&quot;top&quot;,&quot;ignore&quot;:&quot;&quot;,&quot;reference&quot;:&quot;auto&quot;,&quot;class&quot;:&quot;&quot;,&quot;count&quot;:&quot;0&quot;,&quot;legendonly&quot;:&quot;&quot;,&quot;readonly&quot;:&quot;&quot;,&quot;score&quot;:&quot;0&quot;,&quot;starsonly&quot;:&quot;&quot;,&quot;best&quot;:&quot;5&quot;,&quot;gap&quot;:&quot;4&quot;,&quot;greet&quot;:&quot;Rate this product&quot;,&quot;legend&quot;:&quot;0\/5 - (0 votes)&quot;,&quot;size&quot;:&quot;24&quot;,&quot;title&quot;:&quot;ECE-CSE474 Project 4-ADDING FUNCTIONALITY‚Äù Solved&quot;,&quot;width&quot;:&quot;0&quot;,&quot;_legend&quot;:&quot;{score}\/{best} - ({count} {votes})&quot;,&quot;font_factor&quot;:&quot;1.25&quot;}">

<div class="kksr-stars">

<div class="kksr-stars-inactive">
            <div class="kksr-star" data-star="1" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" data-star="2" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" data-star="3" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" data-star="4" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" data-star="5" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
    </div>

<div class="kksr-stars-active" style="width: 0px;">
            <div class="kksr-star" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
            <div class="kksr-star" style="padding-right: 4px">


<div class="kksr-icon" style="width: 24px; height: 24px;"></div>
        </div>
    </div>
</div>


<div class="kksr-legend" style="font-size: 19.2px;">
            <span class="kksr-muted">Rate this product</span>
    </div>
    </div>
<div class="page" title="Page 1">
<div class="layoutArea">
<div class="column"></div>
</div>
</div>
<div class="page" title="Page 6">
<div class="layoutArea">
<div class="column">
&nbsp;

1.0 INTRODUCTION

Consider that your team has been contracted to implement a basic battery management system. You‚Äôve been given this document as a basic framework / specification for what the customer wants. The labs in this course break down the development process as ‚Äòmilestones‚Äô for the customer.

1.1 Development Phases

This project is the second phase in the development of a simple battery management system for high voltage electric transportation applications. The current phase focuses on ‚Äúfleshing out the system‚Äù: adding functionality to tasks that have been developed as part of the basic system architecture, modeling more of the instrumentation in hardware, implementing the high-level data/control flow, managing a dynamic scheduler (linked list), and adding further functional refinement to the display driver and alarm annunciation functions.

2.0 REVISIONS

Table 1 ‚Äì Project Revision Table (Version Control) Version Date Author Description

</div>
</div>
<table>
<tbody>
<tr>
<td>
<div class="layoutArea">
<div class="column">
A

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
11 Jan 2021

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
J.Vining

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
First release of initial architecture specification:

Working with system architecture, a round robin scheduler, task control blocks, and general I/O to implement the first phase of a battery management system

</div>
</div>
</td>
</tr>
<tr>
<td>
<div class="layoutArea">
<div class="column">
B

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
19 Jan 2021

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
J.Vining

</div>
</div>
</td>
<td>
<div class="layoutArea">
<div class="column">
Deletions:

<ol>
<li>Project 2 guidelines sections:
<ul>
<li>Development Phases</li>
<li>Layout of the Project/Guidelines for Success</li>
<li>Recommended Design Approach</li>
</ul>
</li>
<li>Appendix sections:
<ul>
<li>Implementing the TCB</li>
<li>Tips for Building Circuits</li>
</ul>
</li>
</ol>
</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="page" title="Page 7">
<div class="layoutArea">
<div class="column"></div>
</div>
<div class="section">
<div class="layoutArea">
<div class="column">
Additions:

1. Appendix

‚Ä¢ Working with Interrupts (Section 9.1)

2. System controller tasks

<ul>
<li>Hardware timer interrupt (Section 7.3): Hardware timer to
create real-time time base
</li>
<li>HVIL interrupt routine (Sections 7.10): Introduced to set
flag and open contactors in the event HVIL transitions to open

Modifications:
</li>
</ul>
<ol>
<li>Background (Section 3.0)</li>
<li>Project Objectives (Section 4.0)</li>
<li>System controller tasks
<ul>
<li>Scheduler task (Section 7.2): Uses linked list instead of round robin array for calling tasks</li>
<li>Touch screen task (Section 7.4):
<ol>
<li>Display has new state flow for transition between screens:
If an alarm is active but not acknowledged, the display will only show the alarm screen until the alarm is acknowledged.
</li>
<li>The alarm screen has a new button in the event that an alarm is active and needs to be acknowledged.</li>
<li>The alarm and measurement screens show data from real- world measurements.</li>
</ol>
</li>
<li>Measurement task (Section 7.5): Takes analog measurements: temperature, HV current and HV voltage</li>
<li>SOC task (Section 7.8): Constant value of SOC=0</li>
<li>Contactor task (Section 7.9): Contactor state diagram
updated to use HVIL alarm flag as an input for state transition

criteria
</li>
<li>Alarm task (Section 7.11): Calculates &amp; reports alarms based
on measurement data
</li>
</ul>
</li>
</ol>
</div>
</div>
<div class="layoutArea">
<div class="column"></div>
</div>
<div class="layoutArea">
<div class="column">
&nbsp;

</div>
</div>
<div class="layoutArea">
<div class="column">
Deletions:

1. Scheduler section:

</div>
</div>
</div>
</div>
<div class="page" title="Page 8">
<div class="section">
<div class="section">
<div class="layoutArea">
<div class="column">
‚Ä¢ Associating Real Time with the Scheduler 2. Appendix section:

‚Ä¢ Working with Interrupts

Additions:

1. Appendix

‚Ä¢ Doubly Linked Lists: Insert and Delete Functions (Section 9.1)

2. System controller tasks

<ul>
<li>Data logging task (Section 7.6): Write / read measurement
history values to / from EEPROM
</li>
<li>Remote terminal task (Section 7.7): Implement a remote
user terminal to read or clear measurement history data

Modifications:
</li>
</ul>
<ol start="2">
<li>Background (Section 3.0)</li>
<li>Project Objectives (Section 4.0)</li>
<li>System controller tasks
<ul>
<li>Startup task (Section 7.1): Added functionality: Reads measurement history values from EEPROM at startup</li>
<li>Scheduler task (Section 7.2): Time varying tasks now
supported.

<ol>
<li>Implement functions for adding and removing tasks
dynamically from doubly linked list task queue to support

time varying tasks.
</li>
<li>Support more than one periodic task execution rate via
counters
</li>
</ol>
</li>
<li>ALL TASKS: Each task will have a unique periodic execution
rate associated with it
</li>
<li>Measurement task (Section 7.5): Now tracking measurement
history for EEPROM data logging and remote terminal display
</li>
<li>SOC task (Section 7.8): Now calculating SOC based on
physical current, voltage, and temperature measurements
</li>
<li>Contactor task (Section 7.9): Contactor state diagram
updated to use ALL alarm flags as an input for state transitions
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="page" title="Page 9">
<div class="layoutArea">
<div class="column">
3.0 BACKGROUND

Did well on Project 3, exhausted but excited that the quarter is almost over!‚Ä¶

Oh yes, and patience‚Ä¶ Hopefully you‚Äôre learning to practice patience in developing your hardware, software, writing and teamwork skills‚Ä¶ and you‚Äôve come to appreciate your lab partner(s)!

3.1 Cautions and Warnings

Sometimes ‚Äì but only in the most dire of situations ‚Äì sacrificing small animals to the code gremlin living in your ATMega chip could make your code work. However, these critters are not included in your kit and must be purchased separately. Also, be aware that most of the time, code gremlins are not affected by such sacrifices. They simply laugh in your face‚Ä¶bwa ha ha‚Ä¶

Alternately, blaming your partners can work for a short time‚Ä¶ until everyone finds out that you are really to blame.

4.0 PROJECT OBJECTIVES

In this lab, we will continue working with the Arduino Mega (the ‚ÄúSystem Controller‚Äù). This work has the following goals:

<ul>
<li>Develop drivers for more peripheral devices :: Remote System &amp; EEPROM</li>
<li>Upgrade the hardware-based system time base for time varying tasks</li>
<li>Develop a formal communication protocol for a remote system
<ul>
<li>‚Äì &nbsp;Incorporate a remote communications system and network interface into the system.</li>
<li>‚Äì &nbsp;Implement a command-and-control interface</li>
</ul>
</li>
<li>Implement data logging thru EEPROM</li>
<li>Implement and test the new features and capabilities of the system:
<ul>
<li>‚Äì &nbsp;Amend the formal specifications to reflect the new features.</li>
<li>‚Äì &nbsp;Amend existing UML diagrams to reflect the new features model some of the
dynamic aspects of the system.
</li>
<li>‚Äì &nbsp;Amend the requirements and design specifications to reflect the new features</li>
<li>‚Äì &nbsp;Incorporate several additional simple tasks to our system.</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 10">
<div class="layoutArea">
<div class="column">
This project, project report, and program are to be done as a team ‚Äì play nice, share the equipment, keep any viruses (software or otherwise) to yourself, and no fighting.

5.0 SYSTEM ARCHITECTURE

General System Description:

Battery management systems (BMS) are required to ensure the safety, proper operation and long-term reliability of high voltage batteries in electric transportation applications. The system architecture presented is a simplified but representative approach to battery management.

6.0 HARDWARE ARCHITECTURE

The hardware architecture described in this subsection presents the system hardware inputs and outputs as well as the overall layout of the system.

We will be simulating a majority of the following inputs with the exception of the touch screen and accelerometer.

6.1 Inputs

For this stage of the project, the analog and digital inputs highlighted in grey will be implemented in hardware and the remaining analog input sensor will be implemented in the final assignment.

Digital: Analog:

‚Ä¢ Accelerometer (¬±1.5g sensor range scaled 0-3.3V)

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ High voltage interlock loop (HVIL) signal ‚Äì digital input actuated via switch

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Touch screen feedback

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ HV terminal voltage (0-450V sensor range scaled 0-5V)

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ HV terminal current (-25A ‚Äì 25A sensor range scaled 0-5V)

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Temperature (-10¬∞C ‚Äì 45¬∞C sensor range scaled 0-5V)

</div>
</div>
</div>
<div class="page" title="Page 11">
<div class="layoutArea">
<div class="column">
&nbsp;

6.2 Outputs

Digital:

<ul>
<li>Contactor on/off (shown via LEDs)</li>
<li>Touch screen display</li>
</ul>
6.3 I/O Interface Circuits

</div>
<div class="column">
Univ. of Washington, Seattle

</div>
<div class="column">
p. 11 of 30

</div>
</div>
<div class="layoutArea">
<div class="column">
The circuit diagrams used to model the hardware I/O are provided in Section 7.0 Software Architecture, under the task that accesses the circuit. You will use these as a guide to model/simulate/create the hardware interfaces for your project.

6.4 Block Diagram

The block diagram in Figure 1 provides a high-level partially complete block diagram for the system, including all major functional blocks. WE WILL ONLY BE IMPLEMENTING ITEMS IN LIGHT GREY in this project.

Figure 1 ‚Äì High-Level Partially Complete Block Diagram of the Battery Management System (BMS). NOTE: Items in light grey are implemented in this project

</div>
</div>
</div>
<div class="page" title="Page 12">
<div class="layoutArea">
<div class="column">
J. Vining Univ. of Washington, Seattle p. 12 of 30 ECE/CSE 474, Embedded Systems

7.0 SOFTWARE ARCHITECTURE

Your code will include the following tasks:

*The tasks highlighted in grey will be implemented at this stage of the project*

</div>
</div>
<div class="section">
<div class="layoutArea">
<div class="column">
‚Ä¢ Startup

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Scheduler

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Measurement

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Measurement History (Data Logging)

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Touch Screen Task: Display &amp; Touch Input

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Remote Terminal

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ SOC (State of Charge Calculation)

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Contactor

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Alarm

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ HVIL Interrupt

</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Hardware Timer Interrupt

</div>
</div>
</div>
<div class="layoutArea">
<div class="column">
‚Ä¢ Accelerometer

The following subsections describe each of the major functional tasks, as they pertain to this stage of the project. Functionality of each of these tasks shall be modified and expanded as the project moves forward.

7.1 Startup Task: setup()

The Startup Task is the first task to execute and runs only once when the embedded controller wakes up or resets. The startup task shall reside in the Arduino language‚Äôs setup() function which is configured to run once during startup.

This task initializes all: ‚Ä¢ Hardware

o System time base (timers, etc.)

o GPIO (general purpose input/output)

o Communication protocols (UART serial bus, etc) o Interrupts, etc.

‚Ä¢ Software

o Measurement history shared global variables (initializes by reading values from

EEPROM). See the Data Logging Task, Section 7.6, for information on the measurement history variables.

</div>
</div>
</div>
<div class="page" title="Page 13">
<div class="layoutArea">
<div class="column">
o Task data structures

o Task control blocks (TCB) ‚Äì see next section on how to initialize these as a

doubly linked list

7.2 Scheduling Task

The Scheduling Task is executed in the main loop ‚Äì for the Arduino language, this is the loop() function. This task takes care of scheduling and executing the system tasks that make the BMS function.

We will transition from a Scheduler with a single task execution rate (10Hz) to one that supports multiple task execution rates (1Hz, 10Hz, etc.).

7.2.1 Dynamic Scheduler

As before, the dynamic scheduler will:

<ul>
<li>Run each task from the task queue in succession.</li>
<li>Pace execution of the task queue using a hardware interrupt timer that sets the System
Time Base (10Hz as implemented in Project 3).
</li>
<li>Use a task queue composed of a doubly linked list of TCBs.
The same basic rules for task execution apply:

<ul>
<li>Tasks deemed non-atomic shall not be pre-emptable, i.e. no interrupts shall occur
during critical code sections.
</li>
<li>If a task has nothing to do, it shall exit immediately.
In this project, the task queue will support time varying task rates ‚Äì for example, some tasks will run once per second, 1Hz.

The scheduler shall execute at the 10Hz rate set in Project 3; however, some of the tasks will not run each time step ‚Äì they will execute at an integer multiple of the global system time base. The scheduler shall determine which tasks need to run during each time step. Tasks not running at each time step shall be dynamically added and removed from the task queue using an insert function and delete function as described in Section 7.2.2.

Once the scheduler has determined which tasks are to execute during the current time step, it shall execute each TCB in the linked list sequentially without delay and then return to the
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 14">
<div class="layoutArea">
<div class="column">
J. Vining Univ. of Washington, Seattle p. 14 of 30 ECE/CSE 474, Embedded Systems

main loop where it shall be called again after the hardware interrupt timer sets the flag to allow the main loop to cycle again.

7.2.2 Supporting Time Varying Tasks: Adding &amp; Removing Tasks Dynamically from the Task Queue

Tasks that run at a lower rate than the system time base shall be added and removed from the task queue dynamically. A task shall be added to the queue using an insert function and removed using a delete function as described in Appendix Section 9.1.

To determine if a dynamic task is to run or not, create a task counter to track the duration between execution periods. If a task‚Äôs counter indicates it‚Äôs time to run, it shall be added to the queue. Once the task has run, it shall be removed from the queue.

Example:

Take a system time base of 10Hz (0.1s period). There are two tasks running at different rates: Task1 at 10Hz, Task2 at 1Hz. Task1 will run every time step (the global time base). Task2 will run every 10 time steps (10*global time base). Task2 will be added and removed from the dynamic task queue such that it runs once every 10 time steps.

7.2.3 Dynamic Task Queue (TCB Linked List) Implementation

Each element of the task queue doubly linked list shall be a TCB, representing one of the tasks identified in Section 7.0.

Memory for tasks shall NOT be created dynamically ‚Äì in other words, all tasks shall be declared and initialized during startup (all tasks exist in memory indefinitely until power- down). The dynamic scheduler algorithm simply adds or removes tasks that already exist in memory based on the execution rate of the task.

7.3 Hardware Timer Interrupt: timerISR()

A hardware time base is implemented to set the execution rate for the scheduler. This execution rate is known as the system time base, aka the system time step, and is initialized in the Startup Task by attaching an interrupt with a fixed period. The interrupt task for the hardware timer shall set a flag that signals the main loop to cycle again.

The System Time Base shall be set to 10Hz.

</div>
</div>
</div>
<div class="page" title="Page 15">
<div class="layoutArea">
<div class="column">
7.4 Touch Screen Task: Display &amp; Touch Input

The touch screen display task shall include display and touch input functionality.

Tips:

<ul>
<li>You will find it advantageous to create separate functions for touch input and display.</li>
<li>For the display: Only update values on the screen that are changing so your code
executes faster.

This task shall run at a 1s rate with OPTION to run the touch sensing portion at a faster rate for better touch response.
</li>
</ul>
7.4.1 Touch Input

The display shall provide user input buttons to scroll through the following screens:

<ul>
<li>Measurement Screen: Scroll thru measurements</li>
<li>Alarm Screen: Scroll thru / acknowledge alarms</li>
<li>Battery ON/OFF Screen: Option to turn ON / OFF battery
You may use ‚Äúnext‚Äù and ‚Äúprevious‚Äù buttons or a single button for each screen.

7.4.1.1 Screen-Specific Input: Battery ON/OFF Screen

The Battery ON/OFF screen has the same scroll buttons as the other screens PLUS an additional input: an ON / OFF toggle switch. The toggle switch provides user input to turn ON or OFF the battery. See the next section, ‚ÄúDisplay‚Äù, for more details.

7.4.1.2 Screen-Specific Input: Alarm Screen

The Alarm Screen has the same scroll buttons as the other screens PLUS one additional input: an alarm acknowledgement button. In the event that an alarm is active and not acknowledged, the alarm screen will display a single button to allow the user to ACKNOWLEDGE all non-acknowledged active alarms. The next section, ‚ÄúDisplay‚Äù, contains more details
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 16">
<div class="layoutArea">
<div class="column">
J. Vining Univ. of Washington, Seattle p. 16 of 30 ECE/CSE 474, Embedded Systems

7.4.2 Display

The display consists of three screens, described below. The display task shall access shared variables from the following tasks to populate the measurement and alarm screens: Measurement, SOC, and Alarm.

7.4.2.1 MeasurementScreen

The Measurement Screen shall display the following sensor data:

<ul>
<li>State of Charge: &lt;value&gt;</li>
<li>Temperature: &lt;value&gt;</li>
<li>HV Current: &lt;value&gt;</li>
<li>HV Voltage: &lt;value&gt;</li>
<li>HVIL (HV Interlock Loop) Status: &lt;value&gt;
7.4.2.2 AlarmScreen

The Alarm Screen shall display the value of each of the alarms as listed in Section 7.11.
</li>
</ul>
</div>
</div>
<div class="layoutArea">
<div class="column">
<ul>
<li>High Voltage Interlock Alarm:</li>
<li>Overcurrent:</li>
<li>High Voltage Out of Range:</li>
</ul>
</div>
<div class="column">
&lt;state&gt; &lt;state&gt; &lt;state&gt;

</div>
</div>
<div class="layoutArea">
<div class="column">
If any of the alarm states = ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù, the display shall automatically navigate to this screen if it is not there already. When this occurs, a button will appear (as described in the Touch Input section above) with the option to acknowledge the alarm. This acknowledgement by the user is passed as a flag to the Alarm Task, indicating the alarm is acknowledged and may change state to ‚ÄúACTIVE, ACKNOWLEDGED‚Äù.

7.4.2.3 BatteryON/OFFScreen

The Battery ON/OFF Screen shall display the current state of the battery contactors as well as a toggle switch to allow user input to turn ON or OFF the battery. The two toggle switch states yield the following actions:

<ul>
<li>Turn ON‚Ä¶ (CLOSE contactors by sending flag to the Contactor Task)</li>
<li>Turn OFF‚Ä¶ (OPEN contactors by sending flag to the Contactor Task)
Note that the flag is a shared variable that is passed to the Contactor Task. This tells the Contactor Task what state the user wants the battery to be in.
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 17">
<div class="layoutArea">
<div class="column">
7.5 Measurement Tasks: Sensor Measurements

Measurements shall be taken to provide both the BMS and outside world with the system state according to the block diagram in Figure 1.

The Measurement Task shall run at 10Hz (100ms).

7.5.1 Temperature, HV Current &amp; Voltage Measurements

At this stage in the project, we will be implementing temperature, current &amp; voltage measurements using analog inputs. Since we do not have actual temperature, current and voltage sensors, we will be simulating these sensors using test circuits as described in the next section.

7.5.1.1 Test Circuits for Simulated [0-5V] Analog Sensors: ANALOG INPUT

Description of circuit in real-world application:

HV voltage, HV current, and temperature sensors are some of the most important components of the battery management system. These sensors tell the system about the battery‚Äôs electrical and thermal state.

When designing these sensors, the full output range of the sensor is scaled to the input range of the microcontroller‚Äôs analog input pins for maximum resolution. In the case of the ATMega, the analog input range is [0, 5V].

Temperature sensor analog input scaling:

‚Ä¢ Temperature (-10¬∞C ‚Äì 45¬∞C sensor range scaled to analog input 0-5V)

HV voltage and current sensor analog input scaling:

<ul>
<li>HV terminal** voltage (0V ‚Äì 450V sensor range scaled to analog input 0-5V)</li>
<li>HV terminal** current (-25A ‚Äì 25A sensor range scaled to analog input 0-5V)
**Terminal means that the measurement is taken at the battery‚Äôs terminals.

Implementation:

These analog inputs shall be modeled using the circuit in Figure 2:
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 18">
<div class="layoutArea">
<div class="column">
<ul>
<li>The potentiometer allows you to produce a variable voltage in the range [0, 5V], which covers the range of each of the sensors.</li>
<li>Note that the circuit requires a software-enabled pullup resistor within the ATMega. This is configured in the Startup Task when initializing the input pin. If the pullup resistor is not enabled, you should only see 0V at the input no matter the resistance value of the potentiometer.
Figure 2 ‚Äì ANALOG INPUT: Test Circuits for Sensors in Range [0, 5V]
</li>
</ul>
7.5.2 High Voltage Interlock Loop (HVIL)

The HV Interlock Loop circuit will remain the same as implemented in the previous lab. As before, this measurement shall be stored in a shared variable for inter-task data exchange with the display, similar to the other measurement values.

7.5.2.1 Test Circuit for HVIL: DIGITAL INPUT

Description of circuit in real-world application:

The high voltage interlock loop is a circuit that detects whether or not all high voltage connectors are connected since its circuit runs alongside the high voltage cabling. The circuit provides a safety check for the battery management system to ensure that no exposed high voltage cabling is present under operating conditions.

There are many means to implement one of these loops and the detection circuit that reads whether the HVIL is OPEN or CLOSED. For this project, we will simulate a HVIL detection circuit that provides a digital reading to the microcontroller of whether the loop is OPEN or CLOSED.

</div>
</div>
</div>
<div class="page" title="Page 19">
<div class="layoutArea">
<div class="column">
Implementation:

The circuit in Figure 3 shows how to simulate the HVIL detection circuit‚Äôs connection to the microcontroller by using a DIP switch to OPEN and CLOSE the circuit. The expected input at the microcontroller should be (notice these are states):

<ul>
<li>OPEN DIP switch:

o Produces 5V at the digital input pin (reading logic 1) o LED will not light up

o HVIL is OPEN!</li>
<li>CLOSED DIP switch

o Produces 0V at the digital input pin (reading logic 0) o LED will light up

o HVIL is CLOSED, yay, no danger!

Figure 3 ‚Äì DIGITAL INPUT: Test Circuit for High Voltage Interlock Loop (HVIL)
</li>
</ul>
7.5.3 Measurement History Tracking

The Measure Task shall track whether measurement history minimum / maximum values have changed during execution (tracked measurement history values are listed in the Remote Terminal Task, Section 7.6). These measurement history values are stored in shared global variables which are accessed by the following tasks: Data Logging Task and Remote Terminal Task.

The Measurement Task shall update the measurement history values under the following conditions:

1. If measurement history values have changed, the Measure Task shall store the new measurement history values. A flag shall also be set to let the Data Logging Task

</div>
</div>
</div>
<div class="page" title="Page 20">
<div class="layoutArea">
<div class="column">
know which measurement history value has changed, i.e. min or max for a specific

measurement has changed.

2. If a reset flag is set indicating the user has requested to reset EEPROM in the Remote

Terminal Task, the following ‚Äúreset‚Äù values shall be written to EEPROM:

<ul>
<li>HV Current Reset Value</li>
<li>HV Voltage Reset Value</li>
<li>Temperature Reset Value

NOTE: Reset value ‚Äú-1‚Äù is used for measurement values whose lowest range is 0</li>
</ul>
7.6 Data Logging Task: EEPROM Measurement History

The Data Logging Task shall store measurement history values in EEPROM (on the ATMega board). Since EEPROM memory persists when power is removed, it is good for storing measurement history values and for tracking historical operating extremes. Measurement history shall include highest and lowest values for:

<ul>
<li>HV Current</li>
<li>HV Voltage ‚Ä¢ Temperature
This task shall run at a 5s rate since the EEPROM has limited read/write cycles Measurement history data shall be stored in shared global variables for use by both the

Remote Terminal Task and Measurement Task.

Values stored in EEPROM shall be updated under the following conditions:

<ol>
<li>If a measurement history value change flag has been set in the Measure Task, the
Data Logging task shall update the corresponding value in EEPROM.

ÔÉ† The EEPROM memory has a specified life of 100,000 write/erase cycles, so values

are only written to EEPROM when they change
</li>
<li>If a reset flag is set indicating the user has requested to reset EEPROM in the Remote
Terminal Task, the following ‚Äúreset‚Äù values shall be written to EEPROM:

<ul>
<li>HV Current Reset Value</li>
<li>HV Voltage Reset Value</li>
<li>Temperature Reset Value

NOTE: Reset value ‚Äú-1‚Äù is used for measurement values whose lowest range is 0.

Once the Data Logging task has serviced a flag, it shall reset the flag.
</li>
</ul>
</li>
</ol>
</li>
</ul>
</div>
</div>
<div class="layoutArea">
<div class="column">
= 0 = -1 = 0

</div>
</div>
<div class="layoutArea">
<div class="column">
= 0 = -1 = 0

</div>
</div>
</div>
<div class="page" title="Page 21">
<div class="layoutArea">
<div class="column">
You are permitted to use the Arduino language‚Äôs EEPROM.get() and EEPROM.put() functions. These will write any data type or object to EEPROM.

EXTRA CREDIT POINTS (+30): Use the Arduino language‚Äôs EEPROM.read() and EEPROM.write() functions instead of get() and put(). These write a single byte-sized integer value to EEPROM.

NOTE: The first time the program has run with the Data Logging Task added, it is a good idea to reset the measurement history values via the Remote Terminal Task.

7.7 Remote Terminal Task: Formal Communication Protocol

The Remote Terminal Task shall present a menu displaying options for requesting data from the System Controller. The menu will prompt for user input and display the desired output. Output values shall be collected from the System Controller using a formal communication protocol developed by you between the remote terminal and System Controller.

This task shall run at a 1s rate.

It is recommended that you use the Serial0 port and the Arduino IDE Serial Monitor, however you are free to implement the remote terminal menu in another operating environment and over a different communication channel.

The remote terminal shall present the user with the following options:

<pre>          [1]  Reset EEPROM
          [2]  HV Current Range [Hi, Lo]
          [3]  HV Voltage Range [Hi, Lo]
          [4]  Temperature Range [Hi, Lo]
</pre>
<pre>          Enter your menu choice [1-4]: &lt;char&gt;
</pre>
If option 1 is selected, an EEPROM reset flag shall be set ‚Äì both the Measurement Task and Data Logging Task shall monitor this flag. Otherwise, the remote terminal host shall respond with the desired values as accessed via shared global variables.

</div>
</div>
</div>
<div class="page" title="Page 22">
<div class="layoutArea">
<div class="column">
7.8 SOC Task: Calculating Battery State of Charge (SOC)

The battery management system shall track the state of charge (SOC) of the high voltage battery. There are many methods to calculate state of charge, with more advanced systems using coulomb counting and neural networks to track the charge state of the battery. This system shall track SOC by interpolating data within a 2D lookup table with respect to open circuit voltage and temperature as shown in Table 1.

This task shall run at a 100ms rate.

To calculate SOC, the program shall use the measured temperature, terminal voltage and terminal current. Finding the correct temperature entry in the 2D table is simple; however, the open circuit voltage must be back calculated from the measured terminal voltage and current using Ohm‚Äôs Law if the current is non-zero. ASSUME: Internal battery resistance is 0.5Œ© and the battery can be modeled according to the circuit in Figure 4.

Table 2 ‚Äì State of Charge w.r.t. Open Circuit Battery Voltage and Temperature

</div>
</div>
<div class="layoutArea">
<div class="column">
Temperature

(¬∞C) 200V 250V 300V -10¬∞C 0% 10% 35% 0¬∞C 0% 0% 20% 25¬∞C 0% 0% 10% 45¬∞C 0% 0% 0%

</div>
</div>
<div class="layoutArea">
<div class="column">
Open Circuit Voltage (Voc) = (Vterminal + RbattIterminal)

</div>
</div>
<div class="layoutArea">
<div class="column">
350V 400V 100% 100%

80% 100% 60% 100% 50% 100%

</div>
</div>
<div class="layoutArea">
<div class="column">
Figure 4 ‚Äì Battery Internal Circuit Model

</div>
</div>
</div>
<div class="page" title="Page 23">
<div class="layoutArea">
<div class="column">
7.9 Contactor Task: Setting Contactors (signified by LED output)

As discussed in Section 7.9.1 ‚ÄúSimulated Contactor Output Circuit‚Äù, contactors are a safety mechanism to protect the external world from the high voltage potential inside the battery. Within the context of this lab, the functionality of the Contactor Task is to show that logic exists for actuating the contactors properly so that when a power circuit is made available to actuate an actual contactor solenoid, it would function as specified.

For the purposes of this lab, the Contactor Task shall actuate the digital output pin associated with the contactor simulation circuit defined in Section 7.9.1.

This task shall run at a 100ms rate.

States for contactors are:

1. &lt;state1&gt;: ‚ÄúOPEN‚Äù (default/entry state) 2. &lt;state2&gt;: ‚ÄúCLOSED‚Äù

The logic for moving between these states is as follows:

<ul>
<li>Contactors shall be initially OPEN.</li>
<li>Contactors shall be set to OPEN if either or both of the following conditions are met:
o Any alarm state is ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù or ‚ÄúACTIVE, ACKNOWLEDGED‚Äù.

o User requests TURN OFF BATTERY (i.e. OPEN contactors)
</li>
<li>Contactors shall transition to CLOSED when the user inputs a request to TURN ON
BATTERY (i.e. CLOSE contactors) and all alarms are ‚ÄúNOT ACTIVE‚Äù.

NOTE: The alarm flags are defined in Alarm Task, Section 7.11.

NOTE: Request to OPEN/CLOSE contactors shall come in the form of a flag from the Display Task‚Äôs Battery ON/OFF screen. The Contactor Task shall acknowledge the flag after it has acted upon it.

In a real-world system, the OPEN/CLOSE command for the contactors will likely come from another embedded controller in charge of components that the high voltage battery rails interfaces with. This exercise puts that command in the user‚Äôs hands and can be considered a debugging tool.
</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 24">
<div class="layoutArea">
<div class="column">
7.9.1 Simulated Contactor Output Circuit: DIGITAL OUTPUT

Description of circuit in real-world application:

High voltage contactors provide a means to disconnect the battery‚Äôs high voltage rails from the external world. A typical contactor for this application is actuated by a solenoid, which requires more current to actuate that the microcontroller can source / sink

ÔÉ†Important point to note! Microcontrollers are limited in their capability to drive digital outputs over a few watts. Most microcontrollers require external, board-mounted FETs to drive signals requiring higher power levels.

Implementation:

For the purposes of this exercise, the contactor shall be modeled using an LED in series with a resistor as shown in Figure 5. This circuit allows for software simulation with visual confirmation that the output pin is being actuated.

Figure 5 ‚Äì DIGITAL OUTPUT: Test Circuit for Simulating Contactors

7.10 High Voltage Interlock (HVIL) Interrupt Routine

The HVIL interrupt routine shall immediately act upon a transition of the HVIL loop from CLOSED to OPEN. This task is associated with safety and, as such, is the quickest software method available to OPEN the contactors should HVIL transition to an unsafe state.

Conditions for triggering interrupt:

1. HVIL transitions from CLOSED to OPEN.

</div>
</div>
</div>
<div class="page" title="Page 25">
<div class="layoutArea">
<div class="column">
Actions taken during the interrupt:

<ol>
<li>Set the HVIL Alarm to ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù, i.e. &lt;state2&gt; of the alarm states defined in 7.11.</li>
<li>OPEN contactors by writing to the output port directly from the interrupt routine.</li>
</ol>
Interrupt implementation:

<ol>
<li>The interrupt trigger shall be tied to the HVIL input port using conditions described above.</li>
<li>The interrupt routine shall be tied to this task.</li>
<li>Use the attachInterrupt() function to initialize the interrupt.</li>
</ol>
7.11 Alarm Task

The following subsections describe the three alarms provided by the battery management system. Each alarm has three states:

</div>
</div>
<div class="layoutArea">
<div class="column">
<ol>
<li>&lt;state1&gt;:</li>
<li>&lt;state2&gt;:</li>
<li>&lt;state3&gt;:</li>
</ol>
</div>
<div class="column">
‚ÄúNOT ACTIVE‚Äù

ACTIVE, NOT ACKNOWLEDGED ACTIVE, ACKNOWLEDGED

</div>
<div class="column">
(default/entry state)

</div>
</div>
<div class="layoutArea">
<div class="column">
This task shall run at a 100ms rate. 7.11.1 Alarm State Transitions

</div>
</div>
<div class="layoutArea">
<div class="column">
<ul>
<li>Upon first triggering an alarm, the alarm shall transition from ‚ÄúNOT ACTIVE‚Äù to ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù.</li>
<li>Once an alarm is set to ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù, the touch screen shall transition to the alarm screen (unless it is there already) where all alarm statuses are listed. Here the user shall have the option of acknowledging the ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù alarms.</li>
<li>The user must acknowledge all ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù alarms in order to navigate away from the alarm screen (alarms do not need to be acknowledged individually).</li>
<li>Once an ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù alarm is acknowledged on the alarm screen, the alarm shall transition to ‚ÄúACTIVE, ACKNOWLEDGED‚Äù. The Alarm Task receives user input of alarm acknowledgement via a flag sent by the Touch Screen Task.</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 26">
<div class="layoutArea">
<div class="column">
‚Ä¢ Alarms remain in ACTIVE states (&lt;state2&gt; and &lt;state3&gt;) until conditions are met for their dismissal. Conditions for dismissal are described for each alarm in the subsections below.

NOTE: No hysteresis shall be placed on the alarms conditions; however, implementation of hysteresis is typical in a real-world system to avoid repeatedly triggering an alarm when conditions are on the edge.

7.11.2 High Voltage Interlock Alarm

This subtask shall handle transitioning the HVIL alarm to the ‚ÄúACTIVE, ACKNOWLEDGED‚Äù and ‚ÄúNOT ACTIVE‚Äù states.

<ul>
<li>The HVIL Alarm shall be set to ‚ÄúNOT ACTIVE‚Äù if HVIL is CLOSED.</li>
<li>The HVIL Alarm shall be set to ‚ÄúACTIVE, ACKNOWLEDGED‚Äù in the manner
described in Section 7.11.1 Alarm State Transitions.
</li>
<li>*** The interrupt routine defined in Section 7.10 shall handle transitioning the HVIL
Alarm to the ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù state. *** 7.11.3 Over Current Alarm

This subtask shall handle transitioning the Overcurrent alarm between the three alarm states:
</li>
</ul>
<ul>
<li>The Overcurrent Alarm shall be set to ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù if the current measurement lies outside or equal to the range [-5A, 20A].</li>
<li>The Overcurrent Alarm shall be set to ‚ÄúACTIVE, ACKNOWLEDGED‚Äù in the manner described in Section 7.11.1 Alarm State Transitions.</li>
<li>The Overcurrent Alarm shall be set to ‚ÄúNOT ACTIVE‚Äù if the current measurement lies inside of the range (-5A, 20A).
7.11.4 High Voltage Out of Range Alarm

This subtask shall handle transitioning the Voltage out of range alarm between the three alarm states:
</li>
</ul>
‚Ä¢ The Voltage Out of Range Alarm shall be set to ‚ÄúACTIVE, NOT ACKNOWLEDGED‚Äù if the high voltage measurement lies outside or equal to the range [280V, 405V].

</div>
</div>
</div>
<div class="page" title="Page 27">
<div class="layoutArea">
<div class="column">
<ul>
<li>The Voltage Out of Range Alarm shall be set to ‚ÄúACTIVE, ACKNOWLEDGED‚Äù in the manner described in Section 7.11.1 Alarm State Transitions.</li>
<li>The Voltage Out of Range Alarm shall be set to ‚ÄúNOT ACTIVE‚Äù if the current measurement lies inside of the range (280V, 405V).</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 28">
<div class="layoutArea">
<div class="column">
J. Vining Univ. of Washington, Seattle p. 28 of 30 ECE/CSE 474, Embedded Systems

8.0 DELIVERABLES

Project 4 does not have a written report BUT you must submit updated diagrams in a pdf!

<ul>
<li>Use the report format and include the following sections: (1) Title Page, (2) Software
Implementation (include only diagrams in this section), (3) Appendix (explain code

file names here)
</li>
<li>Diagrams must be labeled!! See Software Implementation section below.
We are giving you a break so you can focus on the course exam.

Software Implementation section:
</li>
</ul>
<ul>
<li>In addition to updating the charts and diagrams from Project 3,
ADD the following TWO DIAGRAMS
</li>
<li>Use case diagram for remote terminal</li>
<li>Sequence diagram for remote terminal</li>
<li>Also note whether or not you completed the EEPROM extra credit.
Questions section:
</li>
</ul>
‚Ä¢ What me worry?‚Ä¶ you‚Äôll do fine, I promise üòäüòä

What to do with your CODE???:

<ul>
<li>All code must follow the embedded coding standard.</li>
<li>Code must be commented, explaining intended functionality.</li>
<li>Zip all your code files and submit alongside the report.</li>
<li>Explain code file names in your Appendix.</li>
</ul>
</div>
</div>
</div>
<div class="page" title="Page 29">
<div class="layoutArea">
<div class="column">
9.0 APPENDIX

9.1 Doubly Linked Lists: Insert and Delete Functions

A dynamic scheduler makes use of a doubly linked list as depicted in Figure 6. The dynamic scheduler works as described in the Scheduling Task in Section 7.2, where the list of tasks can grow or shrink by adding or deleting tasks. The insert function and delete function are described in the following subsections.

Figure 6 ‚Äì Doubly Linked List: Graphical Representation

9.1.1 Doubly Linked List Insert Function

Invoking the insert function will add a TCB element to the linked list. This function simply adds a TCB node to the end of the list and updates all necessary pointers. Note that the TCB element to be inserted must be properly declared. See Figure 7 for a sample insert function.

9.1.2 Doubly Linked List Delete Function:

The delete function is a bit more involved but it simply removes a node from the list and updates the necessary pointers. This function should be designed so that a task can delete itself regardless of its position in the list (head, middle, or tail). See Figure 8 for pseudocode for the delete function.

</div>
</div>
<div class="section">
<div class="layoutArea">
<div class="column">
¬©J.D. Olsen, Innovative Software and TA. Ltd.,

Note: Be sure to initialize all pointers to NULL before working with them.

<pre>// Insert function
// Arguments: Pointer to TCB node
// Returns: void
// Function: Adds the TCB node to the end of the list and updates
head and tail pointers</pre>
</div>
</div>
</div>
</div>
<div class="page" title="Page 30">
<div class="section">
<div class="layoutArea">
<div class="column">
<pre>// This function assumes that head and tail pointers have already
been created and are global and that the pointers contained in the
TCB node have already been initialized to NULL
// This function also assumes that the ‚Äúprevious‚Äù and ‚Äúnext‚Äù pointers
in the TCB node are called ‚Äúprev‚Äù and ‚Äúnext‚Äù respectively
</pre>
*/

<pre>void insert(TCB* node)
</pre>
{if(NULL = = head) // If the head pointer is pointing to nothing

{head = node; // set the head and tail pointers to point to this node tail = node;

}else // otherwise, head is not NULL, add the node to the end of the list

{tail -&gt; next = node;

node -&gt; prev = tail; // note that the tail pointer is still pointing // to the prior last node at this point

tail = node; // update the tail pointer

}return; }

</div>
</div>
</div>
<div class="layoutArea">
<div class="column">
Figure 7 ‚Äì Doubly Linked List: Sample Insert Function

</div>
</div>
<div class="section">
<div class="layoutArea">
<div class="column">
<pre>// If the head pointer points to NULL, the list is empty and there is
nothing to delete
</pre>
<pre>// Otherwise, if the head pointer and tail pointer are equal, there
is only one node in the list, set the head and tail to NULL
</pre>
<pre>// Otherwise, if the head pointer is equal to the node we want to
delete set the head pointer to the next node in the list (head = head
-&gt; next)
</pre>
<pre>// Otherwise, if the tail pointer is equal to the node we want to
delete, set the tail pointer to the previous node in the list
</pre>
<pre>// Otherwise, we are in the middle of the list update the previous
and next pointers of the surrounding nodes
</pre>
<pre>// NOTE: this is just pseudo code and does not show all the pointer
updates
// Be particularly careful to properly set the previous and next
pointers of deleted nodes to NULL
</pre>
</div>
</div>
</div>
<div class="layoutArea">
<div class="column">
Figure 8 ‚Äì Doubly Linked List: Pseudocode for the Delete Function

</div>
</div>
</div>
